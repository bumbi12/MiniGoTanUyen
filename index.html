<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Qu·∫£n l√Ω kho si√™u th·ªã</title>
  <!-- Load Bootstrap & Firebase JS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    .product-card {
      transition: transform 0.2s;
      margin-bottom: 20px;
    }
    .product-card:hover {
      transform: scale(1.03);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .note-badge {
      font-size: 0.8rem;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <header class="text-center mb-5">
      <h1 class="display-4">üõí QU·∫¢N L√ù KHO SI√äU TH·ªä</h1>
      <p class="lead">Theo d√µi s·∫£n ph·∫©m v√† s·ªë l∆∞·ª£ng t·ªìn kho</p>
    </header>

    <!-- Product List -->
    <div class="row row-cols-1 row-cols-md-3 g-4" id="productList">
      <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
    </div>

    <!-- Add Product Button -->
    <div class="text-center mt-4">
      <button class="btn btn-success" onclick="showAddProductModal()">
        Ôºã Th√™m s·∫£n ph·∫©m m·ªõi
      </button>
    </div>
  </div>

  <!-- Modal: Th√™m s·∫£n ph·∫©m -->
  <div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Th√™m s·∫£n ph·∫©m m·ªõi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addProductForm">
            <div class="mb-3">
              <label class="form-label">T√™n s·∫£n ph·∫©m</label>
              <input type="text" class="form-control" id="productName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">·∫¢nh (URL)</label>
              <input type="url" class="form-control" id="productImage">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" onclick="addProduct()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Th√™m ghi ch√∫ -->
  <div class="modal fade" id="addNoteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="noteModalTitle">Th√™m ghi ch√∫</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addNoteForm">
            <div class="mb-3">
              <label class="form-label">Ng√†y</label>
              <input type="date" class="form-control" id="noteDate" required>
            </div>
            <div class="mb-3">
              <label class="form-label">S·ªë l∆∞·ª£ng</label>
              <input type="number" class="form-control" id="noteQuantity" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Ghi ch√∫</label>
              <textarea class="form-control" id="noteRemarks" rows="2"></textarea>
            </div>
            <input type="hidden" id="currentProductId">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" onclick="saveNote()">L∆∞u ghi ch√∫</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Xem ghi ch√∫ -->
  <div class="modal fade" id="viewNotesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">L·ªãch s·ª≠ nh·∫≠p kho</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table">
            <thead>
              <tr>
                <th>Ng√†y</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Ghi ch√∫</th>
                <th>H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="notesTableBody">
              <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase & App Code -->
  <script>
    const firebaseConfig = {
  apiKey: "AIzaSyCRc5OmLgHgG57MGwkDvPQLHI74Gv58fgg",
  authDomain: "minigotanuyen.firebaseapp.com",
  projectId: "minigotanuyen",
  storageBucket: "minigotanuyen.firebasestorage.app",
  messagingSenderId: "656079740242",
  appId: "1:656079740242:web:acf2bc7848c33cd1c7ae8b",
  measurementId: "G-T5BSB98505"
};

    // Kh·ªüi t·∫°o Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let addNoteModal = new bootstrap.Modal(document.getElementById('addNoteModal'));
    let viewNotesModal = new bootstrap.Modal(document.getElementById('viewNotesModal'));
    let addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));

    // ===== C√ÅC H√ÄM CH√çNH ===== //
    // 1. Load danh s√°ch s·∫£n ph·∫©m
    function loadProducts() {
      db.collection("products").onSnapshot((snapshot) => {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';
        
        snapshot.forEach(doc => {
          const product = doc.data();
          productList.innerHTML += `
            <div class="col">
              <div class="card product-card h-100">
                ${product.image ? `<img src="${product.image}" class="card-img-top" alt="${product.name}">` : ''}
                <div class="card-body">
                  <h5 class="card-title">${product.name}</h5>
                  <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="openAddNoteModal('${doc.id}', '${product.name}')">
                      ‚ûï Th√™m ghi ch√∫
                    </button>
                    <button class="btn btn-info" onclick="viewNotes('${doc.id}', '${product.name}')">
                      üìä Xem l·ªãch s·ª≠
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
      });
    }

    // 2. M·ªü modal th√™m ghi ch√∫
    function openAddNoteModal(productId, productName) {
      document.getElementById('noteModalTitle').textContent = `Th√™m ghi ch√∫ cho ${productName}`;
      document.getElementById('currentProductId').value = productId;
      document.getElementById('noteDate').valueAsDate = new Date();
      addNoteModal.show();
    }

    // 3. L∆∞u ghi ch√∫ v√†o Firestore
    function saveNote() {
      const productId = document.getElementById('currentProductId').value;
      const date = document.getElementById('noteDate').value;
      const quantity = document.getElementById('noteQuantity').value;
      const remarks = document.getElementById('noteRemarks').value;

      db.collection("product_notes").add({
        productId,
        date,
        quantity: parseInt(quantity),
        remarks,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("‚úÖ ƒê√£ th√™m ghi ch√∫ th√†nh c√¥ng!");
        addNoteModal.hide();
      }).catch(error => {
        alert("‚ùå L·ªói: " + error.message);
      });
    }

    // 4. Xem l·ªãch s·ª≠ ghi ch√∫
    function viewNotes(productId, productName) {
  const modalTitle = document.querySelector('#viewNotesModal .modal-title');
  modalTitle.textContent = `L·ªãch s·ª≠ nh·∫≠p: ${productName}`;
  
  // S·ª≠a th√†nh product_notes thay v√¨ productNotes (n·∫øu c√≥)
  db.collection("product_notes")
    .where("productId", "==", productId)
    .orderBy("date", "desc")
    .get()
    .then((querySnapshot) => {
      const tbody = document.getElementById('notesTableBody');
      tbody.innerHTML = '';
      
      if (querySnapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="4">Ch∆∞a c√≥ d·ªØ li·ªáu nh·∫≠p kho</td></tr>`;
        return;
      }

      querySnapshot.forEach((doc) => {
        const note = doc.data();
        tbody.innerHTML += `
          <tr>
            <td>${note.date || '---'}</td>
            <td>${note.quantity || '0'}</td>
            <td>${note.notes || '---'}</td>
            <td>
              <button class="btn btn-sm btn-danger" 
                      onclick="deleteNote('${doc.id}')">
                X√≥a
              </button>
            </td>
          </tr>
        `;
      });
    })
    .catch((error) => {
      console.error("L·ªói khi l·∫•y d·ªØ li·ªáu:", error);
      });
  
  // Hi·ªÉn th·ªã modal
  new bootstrap.Modal(document.getElementById('viewNotesModal')).show();
}
    // 5. X√≥a ghi ch√∫
    function deleteNote(noteId) {
      if (confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ghi ch√∫ n√†y?")) {
        db.collection("product_notes").doc(noteId).delete()
          .then(() => alert("ƒê√£ x√≥a ghi ch√∫!"))
          .catch(error => alert("L·ªói: " + error));
      }
    }

    // 6. Th√™m s·∫£n ph·∫©m m·ªõi
    function showAddProductModal() {
      addProductModal.show();
    }

    function addProduct() {
      const name = document.getElementById('productName').value;
      const image = document.getElementById('productImage').value;
      
      db.collection("products").add({
        name,
        image: image || null
      }).then(() => {
        alert("‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m m·ªõi!");
        document.getElementById('addProductForm').reset();
        addProductModal.hide();
      }).catch(error => {
        alert("‚ùå L·ªói: " + error.message);
      });
    }

    // Kh·ªüi ch·∫°y khi trang load xong
    window.onload = () => {
      loadProducts();
    };
  </script>
</body>
</html>